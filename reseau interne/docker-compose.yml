version: "3.8"

services:
  resolver:
    container_name: 'resolver'
    build: ./resolver
    ports:
      - 53/udp
      - 53/tcp
    networks:
      secure_zone:
        ipv4_address: 192.168.0.1
  web:
    container_name: 'web'
    build: ./web
    volumes:
      - ./web/default/index.html:/var/www/html/index.html
      - ./web/www.html:/var/www/www.m2-5.ephec-ti.be/index.html
      - ./web/b2b.php:/var/www/b2b.m2-5.ephec-ti.be/index.php
      - ./web/intranet.php:/var/www/intranet.woodytoys.lab/index.php
      - ./web/b2b.m2-5.ephec-ti.be.conf:/etc/apache2/sites-available/b2b.m2-5.ephec-ti.be.conf
      - ./web/www.m2-5.ephec-ti.be.conf:/etc/apache2/sites-available/www.m2-5.ephec-ti.be.conf
      - ./web/intranet.woodytoys.lab.conf:/etc/apache2/sites-available/intranet.woodytoys.lab.conf
    links:
      - db:db
    ports:
      - 80:80
      - 443:443
    command: bash -c "docker-php-ext-install mysqli && docker-php-ext-enable mysqli && a2ensite b2b.m2-5.ephec-ti.be.conf && a2ensite www.m2-5.ephec-ti.be.conf && a2ensite intranet.woodytoys.lab.conf && service apache2 start && tail -f /dev/null"
    networks:
      secure_zone:
        ipv4_address: 192.168.0.2
  db:
    container_name: 'db'
    build: ./db
    volumes:
      - db-data:/var/lib/mysql
    expose:
      - 3306
    networks:
      secure_zone:
        ipv4_address: 192.168.0.3
  mail:
    container_name: 'mail'
    build: ./mail
    expose:
      - 25
      - 143
      - 587
      - 993
    networks:
      secure_zone:
        ipv4_address: 192.168.0.4
  client_1:
    image: alpine
    command: ash -c "apk update && apk upgrade && apk add links lynx bind-tools busybox-extras mysql && echo -e 'search ephec.be\nnameserver 192.168.0.1\noptions edns0 trust-ad ndots:0' > /etc/resolv.conf && tail -f /dev/null"
    container_name: nathan
    networks:
      secure_zone:
        ipv4_address: 192.168.0.200
  client_2:
    image: alpine
    command: ash -c "apk update && apk upgrade && apk add links lynx bind-tools busybox-extras mysql && echo -e 'search ephec.be\nnameserver 192.168.0.1\noptions edns0 trust-ad ndots:0' > /etc/resolv.conf && tail -f /dev/null"
    container_name: francois
    networks:
      secure_zone:
        ipv4_address: 192.168.0.201
volumes:
  db-data:
networks:
  secure_zone:
    ipam:
      driver: default
      config: 
        - subnet: 192.168.0.0/16
          gateway: 192.168.254.254
